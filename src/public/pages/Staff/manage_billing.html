<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Billing Overview - Medicis+</title>
  <link rel="stylesheet" href="/pages/Staff/billings.css">
</head>
<body>
  <div class="container">
    <nav class="sidebar" aria-label="Main navigation">
      <div class="logo">
        <img src=/images/medicis_logo.png alt="Medicis+ Logo">
        <span>Medicis+</span>
      </div>

      <div class="menu">
                <a class="menu-item" href="/redirect/dashboard">
                    <span class="icon">ğŸ‘¥</span>
                    <span class="menu-text">Patients</span>
                </a>

                <a class="menu-item" href="/redirect/appointment">
                    <span class="icon">ğŸ“…</span>
                    <span class="menu-text">Appointments</span>
                </a>

                <a class="menu-item active" href="/redirect/billing">
                    <span class="icon">ğŸ’³</span>
                    <span class="menu-text">Billing</span>
                </a>

      <div class="footer-menu">
        <a class="menu-item" href="./Support.html">
          <span class="icon">â“</span>
          <span class="menu-text">Support</span>
        </a>

        <a class="menu-item" href="./MyAccount.html">
          <span class="icon">ğŸ‘¤</span>
          <div class="menu-labels">
            <span class="menu-text">My Account</span>
            <span class="staff-id" id="staff-id">Staff ID: 1234</span>
          </div>
        </a>
      </div>
    </nav>

    <main class="main-content">
      <div class="page-inner">
        <header class="dashboard-header header-row">
          <div>
            <h1>Billing Overview</h1>
          </div>
          <div class="sign-out-container">
            <button class="sign-out-btn" type="button" onclick="window.location.href = '/staff/logout'">Sign Out</button>
          </div>
        </header>

        <section class="billing-card">
          <h3>Detailed Billing Items</h3>

          <div class="table-wrap">
            <table class="billing-table" aria-describedby="detailed-billing">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Amount Paid</th>
                  <th>Patient</th>
                  <th>Appointment ID</th>
                  <th>Amount due</th>
                  <th>Due date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="populate_table">

              </tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>
</body>
</html>
<script>
  async function load_staff_info() {
    const query = await fetch("/staff/staff_info", {
      method: "GET"
    });

    const res = await query.json();

    if (res.success) {
      document.getElementById("staff-id").innerHTML = "Staff ID: " + res.data.staff_id
      return
    }
    alert(res.message)
  }

  function formatDate(isoString) {
      const d = new Date(isoString);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

  window.onload = async () => {
      load_staff_info();

      try {
        const query = await fetch("/staff/display-billing", {
          method: "GET"
        });

        const tbody = document.getElementById("populate_table");
        const res = await query.json();

        if (res.success && res.data.length > 0) {
          for (let i = 0; i < res.data.length; i++) {
            const row = res.data[i];
            const tr = document.createElement("tr");

            const mkCell = (value) => {
              const td = document.createElement("td");
              td.appendChild(document.createTextNode(value));
              return td;
            };

            tr.appendChild(mkCell(row.billing_id));
            tr.appendChild(mkCell(row.amount_paid));
            tr.appendChild(mkCell(row.patient_id));
            tr.appendChild(mkCell(row.appointment_id));
            tr.appendChild(mkCell(row.amount_due));
            tr.appendChild(mkCell(formatDate(row.due_date)));

            // Status dropdown
            const statusTD = document.createElement("td");
            const statusSelect = document.createElement("select");

            const options = ["Unpaid", "Partially_Paid", "Paid"];
            for (const opt of options) {
              const optionElem = document.createElement("option");
              optionElem.value = opt;
              optionElem.textContent = opt;
              if (opt.toLowerCase() === row.status.toLowerCase()) {
                optionElem.selected = true;
              }
              statusSelect.appendChild(optionElem);
            }

            // Call the status setter when changed
            statusSelect.onchange = () => {
              set_status(statusSelect.value, row.billing_id);
            };

            statusTD.appendChild(statusSelect);
            tr.appendChild(statusTD);

            tbody.appendChild(tr);
          }
          return;
        }

        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.setAttribute("colspan", 7);
        td.appendChild(document.createTextNode("No billing records to display"));
        tr.appendChild(td);
        tbody.appendChild(tr);
      } catch (err) {
        alert(err);
      }
    };

    async function set_status(status, id){
      try{
        const res = await fetch("/staff/set_status", {
          method: "PATCH", 
          headers: {
            "Content-type": "application/json"
          },
          body: JSON.stringify({ status: status, id: id })
        });

        const result = await res.json();
        
        if(result.success){
          window.location.reload()
        }
      }
      catch(err){
        alert(err)
      }
    }

</script>