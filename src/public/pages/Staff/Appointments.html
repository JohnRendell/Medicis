<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Appointments - Medicis+</title>
  <link rel="stylesheet" href="/pages/Staff/appointments.css">
</head>
<body>
  <div class="container">
    <nav class="sidebar" aria-label="Main navigation">
      <div class="logo">
        <img src="/images/medicis_logo.png" alt="Medicis+ Logo">
        <span>Medicis+</span>
      </div>

      <div class="menu">
        <a class="menu-item" href="/redirect/dashboard">
          <span class="icon">ğŸ‘¥</span>
          <span class="menu-text">Patients</span>
        </a>

        <a class="menu-item active" href="/redirect/appointment">
          <span class="icon">ğŸ“…</span>
          <span class="menu-text">Appointments</span>
        </a>

        <a class="menu-item" href="/redirect/billing">
          <span class="icon">ğŸ’³</span>
          <span class="menu-text">Billing</span>
        </a>
      </div>

      <div class="footer-menu">
        <a class="menu-item" href="./Support.html">
          <span class="icon">â“</span>
          <span class="menu-text">Support</span>
        </a>

        <a class="menu-item" href="./MyAccount.html">
          <span class="icon">ğŸ‘¤</span>
          <div class="menu-labels">
            <span class="menu-text">My Account</span>
            <span class="staff-id" id="staff-id">Staff ID: 1234</span>
          </div>
        </a>
      </div>
    </nav>

    <main class="main-content">
      <div class="page-inner">
        <header class="dashboard-header header-row">
          <div>
            <h1>Your Appointments</h1>
            <p class="welcome-text">Welcome Back, <span class="doctor-name" id="staff-name">Juan Dela Cruz</span></p>
          </div>
          <div class="sign-out-container">
            <button class="sign-out-btn" type="button" onclick="window.location.href = '/staff/logout'">Sign Out</button>
          </div>
        </header>

        <section class="appointments-card">
          <h3>Recent Appointments</h3>

          <div class="table-wrap">
            <table class="appointments-table" aria-describedby="recent-appointments">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Patient</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="populate_data">
               
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>
</body>
</html>
<script>
  function formatDate(isoString) {
      const d = new Date(isoString);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function formatTime(isoString) {
      const d = new Date(isoString);
      const hours = String(d.getHours()).padStart(2, "0");
      const minutes = String(d.getMinutes()).padStart(2, "0");
      return `${hours}:${minutes}`;
    }

    let id;
    async function load_staff_into() {
      const query = await fetch("/staff/staff_info", {
        method: "GET"
      });

      const res = await query.json();

      if (res.success) {
        id = res.data.staff_id
        document.getElementById("staff-id").innerHTML = "Staff ID: " + res.data.staff_id
        document.getElementById("staff-name").innerHTML = res.data.name
        return
      }
      alert(res.message)
    }

  window.onload = async () => {
    load_staff_into()
    const tbody = document.getElementById("populate_data");

    try{
      const query = await fetch("/staff/display-appointment", {
        method: "GET"
      });

      const res = await query.json();

      if (res.success && res.data.length > 0) {
        for (let i = 0; i < res.data.length; i++) {
          const tr = document.createElement("tr");

          const appointment_ID = document.createElement("td");
          appointment_ID.appendChild(document.createTextNode(res.data[i].appointment_id));

          const date = document.createElement("td");
          date.appendChild(document.createTextNode(formatDate(res.data[i].appointment_time)));

          const time = document.createElement("td");
          time.appendChild(document.createTextNode(formatTime(res.data[i].appointment_time)));

          const patient = document.createElement("td");
          patient.appendChild(document.createTextNode(res.data[i].patient_id));

          const status = document.createElement("td");
          const statusSelect = document.createElement("select");

          const options = ["scheduled", "completed", "cancelled"];
          
          for (const opt of options) {
            const optionElem = document.createElement("option");
            optionElem.value = opt;
            optionElem.textContent = opt;
            if (opt.toLowerCase() === res.data[i].status.toLowerCase()) {
              optionElem.selected = true;
            }
            statusSelect.appendChild(optionElem);
          }

          statusSelect.onchange = () => {
            set_status(statusSelect.value, res.data[i].appointment_id);
          };

          status.appendChild(statusSelect);

          tr.appendChild(appointment_ID);
          tr.appendChild(date);
          tr.appendChild(time);
          tr.appendChild(patient);
          tr.appendChild(status);

          tbody.appendChild(tr);
        }
        return;
      }

      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.setAttribute("colspan", 5);
      td.appendChild(document.createTextNode("No appointments to display"));
      tr.appendChild(td);
      tbody.appendChild(tr);
    }
    catch(err){
      alert(err)
    }

    async function set_status(status, id) {
      try {
        const res = await fetch("/staff/set_app_status", {
          method: "PATCH",
          headers: {
            "Content-type": "application/json"
          },
          body: JSON.stringify({ status: status, id: id })
        });

        const result = await res.json();

        if (result.success) {
          window.location.reload()
        }
      }
      catch (err) {
        alert(err)
      }
    }
  };

</script>