<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <base href="/pages/User/"> 
    <link rel="stylesheet" href="styles.css" />
    <title>Billing - Medicis+</title>
</head>
<body>
    <div class="sidebar">
        <div class="logo-container">
            <h1 class="logo">Medicis +</h1>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a class="nav-btn" href="/redirect/dashboard"><span class="icon">üë§</span> Patient Profile</a></li>
                <li><a class="nav-btn" href="/redirect/appointment"><span class="icon">üìÖ</span> Appointments</a></li>
                <li><a class="nav-btn active" href="/redirect/billing"><span class="icon">üí≥</span> Billing</a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <button class="footer-btn"><span class="icon">‚ùì</span> Support</button>
            <div class="account-info">
                <button class="footer-btn"><span class="icon">üë§</span> My Account</button>
                <p class="patient-id">Patient ID: <span id="patient-id-display">1234</span></p>
            </div>
        </div>
    </div>

    <div class="main-content">

        <div id="billing" class="page active">
            <div class="page-header" style="position: relative;">
                <h1>Billing Overview</h1>
                <p class="welcome-text">Welcome Back! </p>
                <button id="signout-button" class="btn-secondary signout-top" title="Sign out" style="position: absolute; top: 15px; right: 10px;">Sign Out</button>
                <hr>
            </div>
            <div class="billing-container">
                <div class="billing-summary">
                    <div class="summary-card" id ="amount_due_div">
                        
                    </div>
                    <div class="summary-card" id ="amount_paid_div">
                        
                    </div>
                    <div class="summary-card" id ="balance_div">

                    </div>
                </div>
                <div class="billing-items">
                    <h2>Detailed Billing Items</h2>
                    <table class="billing-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="billing-tbody">

                        </tbody>
                    </table>
                </div>
                <div class="billing-actions">
                    <button class="btn-primary" id="pay-bill-btn">Pay Bill</button>
                    <button class="btn-secondary" id="download-receipt-btn">Download Receipt</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let billingData = [];
        async function loadBillingInfo() {
    try {
        const response = await fetch('/patients/loadbillings');
        if (!response.ok) throw new Error('Failed to fetch billing info');
        
        billingData = await response.json(); 
        console.log('Frontend received:', billingData);
        if (billingData && Array.isArray(billingData)) {
            renderBillingInfo(billingData); 
        }
    } catch (error) {
        console.error('Error fetching billing info:', error);
    }
}
document.addEventListener('DOMContentLoaded', loadBillingInfo);

async function loadPatientInfo() {
    try {
        const response = await fetch('/patients/loadpatientinfo');
        if (!response.ok) throw new Error('Failed to fetch patient info');
        let patientData = await response.json();

        if (patientData) {
            document.getElementById("patient-id-display").innerHTML = patientData.patient_id
        }
    } catch (error) {
        console.error('Error fetching patient info:', error);
    }
}
document.addEventListener('DOMContentLoaded', loadPatientInfo);

async function renderBillingInfo(billings) {
    const tbody = document.getElementById('billing-tbody');
    if (!tbody || !Array.isArray(billings)) return;
    
    console.log('Rendering', billings.length, 'rows');
    
    tbody.innerHTML = billings.map(a => `
        <tr>
            <td>${a.due_date ? new Date(a.due_date).toLocaleDateString() : 'No due date'}</td>
            <td>$${parseFloat(a.amount_due).toFixed(2)}</td>
            <td><span class="status-${a.status.toLowerCase()}">${a.status}</span></td>
        </tr>
    `).join('');

    const totalDue = billings.reduce((sum, a) => sum + parseFloat(a.amount_due || 0), 0);
    const totalPaid = billings.reduce((sum, a) => sum + parseFloat(a.amount_paid || 0), 0);

    const balance = totalDue - totalPaid;

    const amount_due_div = document.getElementById('amount_due_div');  
    if (amount_due_div) {  
        amount_due_div.innerHTML = `
        <h3>Total Amount Due</h3>
        <p class="amount due">$${totalDue.toFixed(2)}</p>
        `;  
    }
      const amount_paid_div = document.getElementById('amount_paid_div');
    if (amount_paid_div) {
        amount_paid_div.innerHTML = `
            <h3>Total Amount Paid</h3>
            <p class="amount paid">$${totalPaid.toFixed(2)}</p>
        `;
    }
      const balance_div = document.getElementById('balance_div');
    if (balance_div) {
        balance_div.innerHTML = `
            <h3>Balance</h3>
            <p class="amount balance">$${balance.toFixed(2)}</p>
        `;
    }
}



        async function Logout() {
    try {
        const response = await fetch('/patients/logout', {
            method: 'GET',
            credentials: 'include',

            redirect: 'follow' 
        });
        if (response.ok) {
            window.location.href = '/'; 
        } else if (response.status === 302) {
            const redirectUrl = response.headers.get('Location');
            if (redirectUrl) {
                console.log("Redirecting manually via Location header:", redirectUrl);
                window.location.href = redirectUrl;
            } else {

                window.location.href = '/'; 
            }

        } else {

            alert(`Logout failed with status ${response.status}.`);
        }
    } catch (error) {
        console.error('Network error during sign out:', error);
        alert('A network error occurred during sign out.');
    }
}

const signoutButton = document.getElementById('signout-button');

if (signoutButton) {
    signoutButton.addEventListener('click', (e) => {
        e.preventDefault(); 
        Logout();
    });
}
    </script>
</body>
</html>
