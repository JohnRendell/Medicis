<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Management Dashboard - Medicis+</title>
    <link rel="stylesheet" href="/pages/Admin/style.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <img src="/images/medicis_logo.png" alt="Medicis+ Logo">
            <div class="logo-text">Medicis+</div>
        </div>
        <button class="nav-button active">üë§ Staffs</button>
        
        <div class="user-info">
            <div class="user-info-icon">üë§</div>
            <div class="user-info-content">
                <div class="user-info-name">Admin</div>
                <div class="user-info-id">Staff ID: admin</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <h1 class="header-title">Admin Dashboard</h1>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Search Section -->
        <div class="search-section">
            <label class="search-label">Search Staff</label>
            <input 
                type="text" 
                class="search-input" 
                id="searchInput" 
                placeholder="Enter Staff ID"
            >
            <button class="btn-add" onclick="openAddModal()">üë§ Add Staff</button>
        </div>

        <!-- Staff Container -->
        <div class="staff-container">
            <h2 class="staff-title">Staff List</h2>
            <table class="staff-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Staff ID</th>
                        <th>Position</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="staffTableBody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
            <div id="emptyState" class="empty-state" style="display: none;">
                No staff members found.
            </div>
        </div>

        <!-- SIGN OUT (moved below the staff-container, right aligned) -->
        <div class="signout-container">
            <button id="signout-button" class="btn-cancel signout-btn" title="Sign out">Sign Out</button>
        </div>
    </div>

    <!-- Add/Edit Staff Modal -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Add Staff</div>
            <form id="staffForm" onsubmit="handleFormSubmit(event)">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="nameInput" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Position (doctor/nurse)</label>
                    <input type="text" class="form-input" id="positionInput" required>
                </div>

                <!-- NEW: Username & Password fields (placed under Position) -->
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="usernameInput" autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="passwordInput" autocomplete="new-password">
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-submit" id="submitBtn">Add Staff</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Confirm Delete</div>
            <p style="margin-bottom: 25px; color: #333;">Are you sure you want to remove this staff member?</p>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn-danger" onclick="confirmDelete()">üóëÔ∏è Delete</button>
            </div>
        </div>
    </div>

    <script>


document.getElementById('searchInput').addEventListener('input', function(e) {
  const searchTerm = e.target.value.trim().toLowerCase();
  filterStaffTable(searchTerm);
});


function filterStaffTable(searchTerm) {
  if (!staffList || !Array.isArray(staffList)) return;
  
  const filteredStaff = staffList.filter(staff => {

    return staff.staff_id?.toString().includes(searchTerm) ||
           staff.name?.toLowerCase().includes(searchTerm) ||
           staff.position?.toLowerCase().includes(searchTerm) ||
           staff.username?.toLowerCase().includes(searchTerm);
  });
  
  renderStaffTable(filteredStaff);
}

// 4. Clear search (optional)
document.getElementById('searchInput').addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    this.value = '';
    renderStaffTable(staffList);
  }
});

        async function deleteStaff(userId) {
        if (!confirm('Delete this staff?')) return;
        
        try {
            const res = await fetch(`/admin/deletestaff/${userId}`, { 
            method: "DELETE"
            });
            
            const data = await res.json();
            
            if (data.success) {
            await loadStaffInfo();  // Refresh table
            showCustomMessage("Staff deleted!", false);
            } else {
            showCustomMessage(data.message, true);
            }
        } catch (error) {
            showCustomMessage("Delete failed", true);
        }
        }


        let staffList = [];
        // load staff info
        async function loadStaffInfo() {
        try {
            const response = await fetch('/admin/loadstaffinfo');
            if (!response.ok) throw new Error('Failed to fetch staff info');
            
            staffList = await response.json(); 
            
            if (staffList && Array.isArray(staffList)) {
            renderStaffTable(staffList);
            }
        } catch (error) {
            console.error('Error fetching staff info:', error);
        }
        }
function renderStaffTable(staffData = staffList) {  // Default to full list
  const tbody = document.getElementById('staffTableBody');
  const emptyState = document.getElementById('emptyState');
  
  tbody.innerHTML = '';
  
  if (staffData.length === 0) {
    emptyState.textContent = 'No staff found';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  staffData.forEach(staff => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${staff.name || ''}</td>
      <td>${staff.staff_id || ''}</td>
      <td>${staff.position || ''}</td>
      <td>
        <button class="btn-remove" onclick="deleteStaff(${staff.user_id})">üë§ Remove</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

        document.addEventListener('DOMContentLoaded', loadStaffInfo);


        // Open add modal
        function openAddModal() {
            
            document.getElementById('modalTitle').innerText = 'Add Staff';
            document.getElementById('staffForm').reset();
            document.getElementById('submitBtn').innerText = 'Add Staff';
            // ensure username/password cleared
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('staffModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('staffModal').classList.remove('active');
            
        }

async function handleFormSubmit(event) {
  event.preventDefault();
  try {
    const formData = {
      fullname: document.getElementById('nameInput').value,
      position: document.getElementById('positionInput').value,
      username: document.getElementById('usernameInput').value || '',
      password: document.getElementById('passwordInput').value || ''
    };

    if(!formData.fullname || !formData.username || !formData.password || !formData.position){
      showCustomMessage("All fields required", true);
      return;  
    }
    if(formData.position !== 'doctor' && formData.position !== 'nurse') {
      showCustomMessage("Position should be doctor or nurse only!", true);
      return;  
    }
  
        const res = await fetch("/admin/createstaff", { 
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
        });
    
        const data = await res.json();
        
        if (!res.ok) {  
        throw new Error(data.message || 'Server error');
        }
        
        if(data.success) {
        await loadStaffInfo(); 
        closeModal();
        showCustomMessage("Staff created successfully!", false);
        } else {
        showCustomMessage(data.message, true);
        }
    } catch (error) {
        console.error('Error:', error);
        showCustomMessage(error.message || "Server error", true);
    }

    }

        // Open delete modal
        function openDeleteModal(id) {
            deletingId = id;
            document.getElementById('deleteModal').classList.add('active');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deletingId = null;
        }

        // Confirm delete
        function confirmDelete() {
            staffList = staffList.filter(s => s.id !== deletingId);
            showAlert('Staff member removed successfully!', 'success');
            renderStaffTable();
            closeDeleteModal();
        }

        // Show alert
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerText = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => alert.remove(), 3000);
        }

        // Close modals on Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (typeof closeModal === 'function') closeModal();
                if (typeof closeDeleteModal === 'function') closeDeleteModal();
            }
        });


        async function Logout() {
    try {
        const response = await fetch('/admin/logout', {
            method: 'GET',
            credentials: 'include',

            redirect: 'follow' 
        });
        if (response.ok) {
            window.location.href = '/'; 
        } else if (response.status === 302) {
            const redirectUrl = response.headers.get('Location');
            if (redirectUrl) {
                console.log("Redirecting manually via Location header:", redirectUrl);
                window.location.href = redirectUrl;
            } else {

                window.location.href = '/'; 
            }

        } else {

            alert(`Logout failed with status ${response.status}.`);
        }
    } catch (error) {
        console.error('Network error during sign out:', error);
        alert('A network error occurred during sign out.');
    }
}
const signoutButton = document.getElementById('signout-button');

if (signoutButton) {
    signoutButton.addEventListener('click', (e) => {
        e.preventDefault(); 
        Logout();
    });
}

    </script>
</body>
</html>